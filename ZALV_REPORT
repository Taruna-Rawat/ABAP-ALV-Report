REPORT ZALV_REPORT.

TYPE-POOLS : SLIS .

TABLES: MAKT,EKKO,EKPO,EKBE .

TYPES : BEGIN OF ty_makt,
          MATNR TYPE MAKT-MATNR,
          MAKTX TYPE MAKT-MAKTX,
        END OF ty_makt,

       BEGIN OF ty_ekko,
         EBELN TYPE EKKO-EBELN,
         BUKRS TYPE EKKO-BUKRS,
         ERNAM TYPE EKKO-ERNAM,
        END OF ty_ekko,

       BEGIN OF ty_ekpo,
         EBELN TYPE EKPO-EBELN,
         MATNR TYPE EKPO-MATNR,
       END OF ty_ekpo,

       BEGIN OF ty_ekbe,
         EBELN TYPE EKBE-EBELN,
         EBELP TYPE EKBE-EBELP,
         BELNR TYPE EKBE-BELNR,
         BUDAT TYPE EKBE-BUDAT,
      END OF ty_ekbe ,

        BEGIN OF ty_main,
          MATNR TYPE EKPO-MATNR,
          EBELN TYPE EKPO-EBELN,
          BUKRS TYPE EKKO-BUKRS,
          ERNAM TYPE MARA-ERNAM,
          MAKTX TYPE MAKT-MAKTX,
          EBELP TYPE EKBE-EBELP,
          BELNR TYPE EKBE-BELNR,
          BUDAT TYPE EKBE-BUDAT,
        END OF ty_main .

DATA: IT_MAKT TYPE TABLE OF ty_makt,
      WA_MAKT TYPE ty_makt,
      IT_EKKO TYPE TABLE OF ty_ekko,
      WA_EKKO TYPE ty_ekko,
      IT_EKPO TYPE TABLE OF ty_ekpo,
      WA_EKPO TYPE ty_ekpo,
      IT_EKBE TYPE TABLE OF ty_EKBE,
      WA_EKBE TYPE ty_ekbe,
      IT_MAIN TYPE TABLE OF ty_main,
      WA_MAIN TYPE ty_main ,
      IT_FIELDCAT TYPE SLIS_T_FIELDCAT_ALV,
      WA_FIELDCAT TYPE SLIS_FIELDCAT_ALV .

SELECTION-SCREEN BEGIN OF BLOCK BLOCK1 WITH FRAME TITLE TITLE1 .
  SELECT-OPTIONS : MAT_CODE FOR EKPO-MATNR ,
                   PO for EKPO-EBELN .
SELECTION-SCREEN END OF BLOCK BLOCK1 .

START-OF-SELECTION.
  PERFORM GET_DATA .
  PERFORM CREATE_FIELDCAT .
  PERFORM FINAL_TABLE .
  PERFORM DISPLAY_DATA.
END-OF-SELECTION .


FORM GET_DATA .
*header table : ekko
if po is not INITIAL .
   SELECT EBELN BUKRS ERNAM FROM EKKO INTO TABLE IT_EKKO
                               where ebeln eq po .
else.
   SELECT EBELN BUKRS ERNAM FROM EKKO INTO TABLE IT_EKKO where ebeln ne '' .
endif.

*item table : ekpo
 if it_ekko is not INITIAL  .
  SELECT EBELN MATNR FROM EKPO INTO TABLE IT_EKPO
                             FOR ALL ENTRIES IN it_ekko
                             where ebeln = it_ekko-ebeln and matnr in mat_code and matnr ne '' .
  SELECT EBELN EBELP BELNR BUDAT FROM EKBE INTO TABLE IT_EKBE
                             FOR ALL ENTRIES IN IT_EKPO
                             WHERE EBELN = IT_EKPO-EBELN.
 if it_ekpo is not INITIAL .
  SELECT MATNR MAKTX FROM MAKT INTO TABLE IT_MAKT
                     FOR ALL ENTRIES IN IT_EKPO
                    WHERE MATNR = IT_EKPO-MATNR .
endif.
endif.
ENDFORM .


FORM CREATE_FIELDCAT .
  WA_FIELDCAT-COL_POS = '1' .
  WA_FIELDCAT-FIELDNAME = 'MATNR'.
  WA_FIELDCAT-TABNAME = 'IT_EKPO'.
  WA_FIELDCAT-REF_FIELDNAME = 'MATNR'.
  WA_FIELDCAT-REF_TABNAME = 'EKPO'.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR WA_FIELDCAT.

  WA_FIELDCAT-COL_POS = '2'.
  WA_FIELDCAT-FIELDNAME = 'EBELN'.
  WA_FIELDCAT-TABNAME = 'IT_EKPO'.
  WA_FIELDCAT-REF_FIELDNAME = 'EBELN'.
  WA_FIELDCAT-REF_TABNAME = 'EKPO'.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR WA_FIELDCAT.

  WA_FIELDCAT-COL_POS = '3'.
  WA_FIELDCAT-FIELDNAME = 'BUKRS'.
  WA_FIELDCAT-TABNAME = 'IT_EKKO'.
  WA_FIELDCAT-REF_FIELDNAME = 'BUKRS'.
  WA_FIELDCAT-REF_TABNAME = 'EKKO'.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR WA_FIELDCAT.

  WA_FIELDCAT-COL_POS = '4'.
  WA_FIELDCAT-FIELDNAME = 'ERNAM'.
  WA_FIELDCAT-TABNAME = 'IT_MARA'.
  WA_FIELDCAT-REF_FIELDNAME = 'ERNAM'.
  WA_FIELDCAT-REF_TABNAME = 'MARA'.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR WA_FIELDCAT.

  WA_FIELDCAT-COL_POS = '5'.
  WA_FIELDCAT-FIELDNAME = 'MAKTX'.
  WA_FIELDCAT-TABNAME = 'IT_MAKT'.
  WA_FIELDCAT-REF_FIELDNAME = 'MAKTX'.
  WA_FIELDCAT-REF_TABNAME = 'MAKT'.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR WA_FIELDCAT .

  WA_FIELDCAT-COL_POS = '6'.
  WA_FIELDCAT-FIELDNAME = 'EBELP'.
  WA_FIELDCAT-TABNAME = 'IT_EKBE'.
  WA_FIELDCAT-REF_FIELDNAME = 'EBELP'.
  WA_FIELDCAT-REF_TABNAME = 'EKBE'.
  APPEND WA_FIELDCAT TO IT_FIELDCAT .
  CLEAR WA_FIELDCAT .

  WA_FIELDCAT-COL_POS = '7' .
  WA_FIELDCAT-FIELDNAME = 'BELNR'.
  WA_FIELDCAT-TABNAME = 'IT_EKBE'.
  WA_FIELDCAT-REF_FIELDNAME = 'BELNR'.
  WA_FIELDCAT-REF_TABNAME = 'EKBE'.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR WA_FIELDCAT.

  WA_FIELDCAT-COL_POS = '8' .
  WA_FIELDCAT-FIELDNAME = 'BUDAT'.
  WA_FIELDCAT-TABNAME = 'IT_EKBE'.
  WA_FIELDCAT-REF_FIELDNAME = 'BUDAT'.
  WA_FIELDCAT-REF_TABNAME = 'EKBE'.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR WA_FIELDCAT.

ENDFORM.


FORM DISPLAY_DATA.
                               CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
                                EXPORTING
                                  I_CALLBACK_PROGRAM                = ' SY-REPID '
                                  IT_FIELDCAT                       = IT_FIELDCAT
                                 TABLES
                                   T_OUTTAB                          =    IT_MAIN      .
ENDFORM.

FORM FINAL_TABLE.

  LOOP AT IT_EKPO INTO WA_EKPO .

    MOVE-CORRESPONDING WA_EKPO TO WA_MAIN.

    READ TABLE IT_MAKT INTO WA_MAKT WITH KEY MATNR = WA_MAIN-MATNR.
    IF SY-SUBRC = 0.
      WA_MAIN-MAKTX = WA_MAKT-MAKTX.
    ENDIF.

    READ TABLE IT_EKKO INTO WA_EKKO WITH KEY EBELN = WA_MAIN-EBELN.
    IF SY-SUBRC = 0.
      WA_MAIN-ERNAM = WA_ekko-ERNAM.
      WA_MAIN-BUKRS = WA_EKKO-BUKRS.
    ENDIF.

    READ TABLE IT_EKBE INTO WA_EKBE WITH KEY EBELN = WA_MAIN-EBELN.
    IF SY-SUBRC = 0.
      WA_MAIN-EBELP = WA_EKBE-EBELP.
      WA_MAIN-BELNR = WA_EKBE-BELNR.
      WA_MAIN-BUDAT = WA_EKBE-BUDAT.
    ENDIF.

    APPEND WA_MAIN TO IT_MAIN.
    CLEAR WA_MAIN.

   ENDLOOP.
*   SORT IT_MAIN BY BUKRS MATNR.
ENDFORM.
